syntax = "proto3";

package shared.v1;

import "validate/validate.proto";
import "shared/v1/misc.proto";
import "google/protobuf/timestamp.proto";

option go_package = "wello-fiat-hub/api/shared/v1;v1";
option java_multiple_files = true;
option java_package = "dev.kratos.api.shared.v1";
option java_outer_classname = "SharedProtoV1";

message PaymentMethod {
  optional string id = 1 [(validate.rules).string.prefix = "pm_"];
  optional bool store = 2;
  optional string type = 3;
  optional string status = 4;
  optional string user_id = 5;
  oneof method {
    Card card = 6;
    MobileMoney mobile_money = 7;
    BankAccount bank_account = 8;
    BankTransfer bank_transfer = 9;
    ApplePay apple_pay = 10;
    OpenBanking open_banking = 11;
  };

  oneof authorization {
    CardAuthorization card_authorization = 12; // also used for apple pay
  };

  message CardAuthorization {
    optional string cvv = 1 [(validate.rules).string.len = 3];
    optional bool auto_capture = 2;
    optional bool three_ds_required = 3;
    optional bool three_ds_allow_upgrade = 4;
  }
}

message Card {
  string card_number = 1;
  string holder_name = 2;
  int32 expiry_month = 3 [(validate.rules).int32 = { ignore_empty: true, gt: 0, lt: 13 }];
  int32 expiry_year = 4 [(validate.rules).int32 = { ignore_empty: true, gte: 2025 }];
  optional shared.v1.Address billing_address = 5;
  optional string bin = 6;
  optional string last4 = 7;
  optional string scheme = 8;
  optional string type = 9;
  optional string issuer = 10;
  optional string issue_country = 11 [(validate.rules).string.pattern = "^[A-Z]{2}$"];
  optional string product_id = 12;
  optional string product_type = 13;
}

message CardStats {
  string card_id = 1 [(validate.rules).string.prefix = "card_"];
  string channel_id = 2;
  optional bool supports_payin = 3;
  optional bool supports_payout = 4;
  optional bool supports_fast_funds = 5;
  optional bool supports_cross_boarder_payout = 6;
  optional bool supports_cross_boarder_fast_funds = 7;
  int32 payin_attempts = 8;
  int32 payin_successes = 9;
  int32 payout_attempts = 10;
  int32 payout_successes = 11;
  google.protobuf.Timestamp last_success_at = 12;
  google.protobuf.Timestamp last_failed_at = 13;
}

message PaymentData {
  string version = 1 [(validate.rules).string = { in: ["RSA_v1", "EC_v1", "EC_v2"] }];
  string data = 2 [(validate.rules).string.min_len = 1];
  string signature = 3 [(validate.rules).string.min_len = 1];
  message Header {
    string ephemeral_public_key = 1;
    string public_key_hash = 2;
    string transaction_id = 3;
  }
  Header header = 4 [(validate.rules).message.required = true];
  message DecryptedData {
    string token = 1;
    string token_format = 2;
    string holder_name = 3;
    string bin = 4;
    string last_four = 5;
    int32 expiry_year = 6;
    int32 expiry_month = 7;
    string type = 8;
    string category = 9;
    string scheme = 10;
    string issuer = 11;
    string issue_country = 12;
    string product_id = 13;
    string product_type = 14;
    string phone = 15;
  }
  optional DecryptedData decrypted_data = 5;
}



message ApplePay {
  PaymentData payment_data = 1;
  optional shared.v1.Address billing_address = 3;
  optional string email = 4 [(validate.rules).string.email = true];
  optional string phone = 5 [(validate.rules).string.pattern = "^\\+?\\d(?:[\\d\\s\\-\\(\\)]{6,19})$"];
  optional string first_name = 6;
  optional string last_name = 7;
}

message MobileMoney {
  string sub_type = 1 [(validate.rules).string = {in: ["mobile_money_franco", "mobile_money_ghana", "mobile_money_uganda", "mobile_money_tanzania", "mobile_money_zambia", "mobile_money_rwanda", "mpesa"]}];
  optional string network = 2;
  optional string phone_number = 3 [(validate.rules).string.pattern = "^\\+?\\d(?:[\\d\\s\\-\\(\\)]{6,19})$"];
  optional string email = 4 [(validate.rules).string.email = true];
  optional string fullname = 5;
  optional string order_id = 6;
  optional string tx_ref = 7;
  optional string authorization_code = 8;
  optional string country = 9 [(validate.rules).string.pattern = "^[A-Z]{2}$"];
}

message BankAccount {
  optional string account_number = 1;
  optional string account_expiration = 2;
  optional string bank_code = 3;
  optional string bank_country = 4 [(validate.rules).string.pattern = "^[A-Z]{2}$"];
  optional string bank_name = 5;
  optional string routing_number = 6;
  optional string sort_code = 7;
  optional string swift_code = 8;
  optional string account_name = 9;
}

message BankTransfer {
  optional string account_number = 1;
  optional string fullname = 2;
  optional string phone_number = 3 [(validate.rules).string.pattern = "^\\+?\\d(?:[\\d\\s\\-\\(\\)]{6,19})$"];
  optional string email = 4 [(validate.rules).string.email = true];
}

message OpenBanking {
  optional string provider = 1;
  optional string bank_id = 2;
  optional string country = 3 [(validate.rules).string.pattern = "^[A-Z]{2}$"];
  optional string account_number = 4;
  optional string fullname = 5;
  optional string phone_number = 6 [(validate.rules).string.pattern = "^\\+?\\d(?:[\\d\\s\\-\\(\\)]{6,19})$"];
  optional string email = 7 [(validate.rules).string.email = true];
}