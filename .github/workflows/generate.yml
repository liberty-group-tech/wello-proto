name: generate protocol buffer

on:
  workflow_dispatch:
  push:
    branches:
      - 'gen/**/**'

permissions: write-all

jobs:
  generate:
    name: generate
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v3
        with:
          ssh-known-hosts: "github.com"
          ssh-key: ${{ secrets.SSH_PRIVATE_KEY }}
          fetch-depth: 0
      
      - name: Set up Go
        uses: actions/setup-go@v3
        with:
          go-version: 1.18

      - name: Install unzip curl
        run: |
          sudo apt update
          sudo apt install unzip curl

      - name: Install protoc-gen-go
        run: |
          go install github.com/golang/protobuf/protoc-gen-go@v1.4.3
          mv $(go env GOPATH)/bin/protoc-gen-go /usr/local/bin/

      - name: Install protoc 
        run: |
          curl -LO https://github.com/protocolbuffers/protobuf/releases/download/v3.14.0/protoc-3.14.0-linux-x86_64.zip
          sudo unzip -o protoc-3.14.0-linux-x86_64.zip -d /usr/local bin/protoc
          sudo unzip -o protoc-3.14.0-linux-x86_64.zip -d /usr/local 'include/*'
          sudo protoc --version
          rm -rf protoc-3.14.0-linux-x86_64.zip

      - name: config Bot account
        env:
          BOT_GITHUB_USERNAME: ${{ secrets.BOT_GITHUB_USERNAME }}
          BOT_GITHUB_EMAIL: ${{ secrets.BOT_GITHUB_EMAIL }}
        run: |
          git config --global user.name $BOT_GITHUB_USERNAME
          git config --global user.email $BOT_GITHUB_EMAIL

      - name: Extract branch name
        id: extract_branch
        run: |
          echo "branch=${GITHUB_HEAD_REF:-${GITHUB_REF#refs/heads/}}" >> $GITHUB_OUTPUT

      - name: target directory
        id: extract_directory
        run: |
          # e.g. gen/lino-app-backend/test  -> lino-app-backend
          echo ${{ steps.extract_branch.outputs.branch }} | awk -F'/' '{print $2}'
          echo "directory=$(echo ${{ steps.extract_branch.outputs.branch }} | awk -F'/' '{print $2}')" >> $GITHUB_OUTPUT

      - name: generate
        env:
          generate_module: ${{ steps.extract_directory.outputs.directory }}
        run: |
          sudo protoc --go_out=plugins=grpc,paths=source_relative:. $generate_module/*.proto

      - name: commit
        env:
          GITHUB_TOKEN: ${{ secrets.BOT_GITHUB_TOKEN }} # Note: that the default secrets.GITHUB_TOKEN must provide
        run: |
          if [ -z "$(git status --porcelain ./)" ]; then
            echo "nothing to update."
          else
            git add .
            git commit -m "ü§û ${{ steps.extract_directory.outputs.directory }} generate protocol buffer ‚≠êÔ∏è"
            git push origin HEAD:${{ steps.extract_branch.outputs.branch }}
          fi
